
set $https_test   "";

if ($http_x_forwarded_proto != 'https' ) {
	set $https_test   "${https_test}+nhttps";
}

if ($http_x_glb_forwarded = 'true' ) {
	set $https_test   "${https_test}+gclb";
}

if ($https_test = '+nhttps+gclb') {
    return 308 https://$host$request_uri;
}

if ($proxy_protocol_server_port != '443') {
	set $https_test   "${https_test}+n443";
}

if ($https_test = '+nhttps+n443') {
	return 308 https://$host$request_uri;
}

proxy_redirect "http://$host" "https://$host";
