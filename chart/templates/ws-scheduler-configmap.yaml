# Copyright (c) 2020 Gitpod GmbH. All rights reserved.
# Licensed under the MIT License. See License-MIT.txt in the project root for license information.

{{ $comp := .Values.components.wsScheduler -}}
{{- if not $comp.disabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: ws-scheduler-config
  labels:
    app: {{ template "gitpod.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
data:
  config.json: |-
    {
        "pprof": {
            "addr": "localhost:6060"
        },
        "prometheus": {
            "addr": ":9500"
        },
        "scheduler": {
            "schedulerName": "{{ $comp.schedulerName }}",
            "namespace": "{{ .Release.Namespace }}",
            "nodeLabelSelector": {},
            "strategyName": "DensityAndExperience",
            "densityAndExperienceConfig": {
                "workspaceFreshPeriodSeconds": 120,
                "nodeFreshWorkspaceLimit": 2
            }
            {{- if $comp.ratelimit }}
            , "rateLimit": {
                "maxRPS": {{ $comp.ratelimit.maxRPS }}
            }
            {{- end }}
        }
        {{ if $comp.scaler.enabled }}
        ,
        "scaler": {
            "enabled": true,
            "driver": {
                "wsmanAddr": "ws-manager:8080",
                "workspaceImage": "{{ template "gitpod.comp.imageFull" (dict "root" . "gp" $.Values "comp" .Values.components.workspace.defaultImage) }}",
                "ideImage": "{{ template "gitpod.comp.imageFull" (dict "root" . "gp" $.Values "comp" .Values.components.workspace.theiaImage) }}",
                "maxGhostWorkspaces": {{ $comp.scaler.maxGhostWorkspaces | default 0 }},
                "schedulerInterval": "{{ $comp.scaler.schedulerInterval | default "5s" }}",
                "renewal": {
                    "interval": {{ $comp.scaler.renewal.interval | quote }},
                    "percentage": {{ $comp.scaler.renewal.percentage }}
                }
            },
            "controller": {{ $comp.scaler.controller | toJson }}
        }
        {{ end }}
    }
{{- end -}}