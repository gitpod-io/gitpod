# Overview
ws-deployment is a cli used to deploy gitpod workspace to a new cluster. It uses a combination of existing tools, scripts and methodologies to achieve this.

Please refer to [this design doc](https://www.notion.so/gitpod/Deployment-Process-Workspace-5f082cc8387447f5940ffb8389bb4fc7) where we had first set of proposals and discussions. For the first iteration we decided to do things with the following in mind:
`Create immutable workspace clusters and avoid as much manual intervention as possible.`

What this means is we can create same terraform modules and helm values yaml files when a set of same parameters is passed (Note: We are however creating a random id in code for a new cluster). This will help us avoid checking in terraform modules to ops repository. We can generate the same set of modules by running with a bunch of parameters. This is particulary required when we want to destroy a cluster through terraform.

# What
Broadly these are the steps/things that it does in the given order:

1. Use [ops repository](https://github.com/gitpod-io/ops) to create Terraform Modules based on the given config
1. Use terraform to apply these terraform module. This creates workspace cluster/(s) and associated infrastructure
1. Installs gitpod on the cluster/(s) created in previous step using helm
1. Run a smoke test on these clusters
1. Register the clusters with right cordoned and govern flag to appropriate meta clusters as defined in the config
1. Shift Traffic to the new clusters


# How
## Quick Start

Use the below command to get started:
```sh
go run main.go deploy --config /path/to/config.yaml --versions-manifest /path/to/versions.yaml
```

## Overall Flow Diagram
![Gitpod Workspace Deployment](https://user-images.githubusercontent.com/32481722/137714660-7083d730-d3d6-481d-8bd3-82ec2bb83dad.png "Gitpod Worksapce Deployment")

## Flow Steps
This is the flow that we are building to achive automated gitpod deployment:

1. A config (default `$HOME/ws-deployment.yaml`) is read by the cli `ws-deployment` and validated based on the version. Currently the config looks similar to below but is constantly being updated as we make progress.
    ```yaml
    version: v1
    project:
      id: gitpod-dev-staging
      gcpSACredFile: /mnt/secrets/gcp-sa/service-account.json
      network: gitpod-dev-staging
      dnsZone: gitpod-dev-staging-com
      bucket: gitpod-dev-staging-bucket
    metaClusters:
    - name: dev-stag-meta-eu01
      region: europe-west1
    - name: dev-stag-meta-us01
      region: us-west1
    workspaceClusters:
    - region: europe-west1
      prefix: eu
      governedBy: dev-stag-meta-eu01
      type: gke
      valuesFiles:
      - values.dev-staging.yaml
      - values.ws-cluster.yaml
    - region: us-west1
      prefix: us
      governedBy: dev-stag-meta-us01
      type: gke
      valuesFiles:
      - values.dev-staging.yaml
      - values.ws-cluster.yaml
    ```
    TODO(prs) Explanation of each field
1. A random cluster id is generated which is used to generate cluster names. e.g. a cluster id 17 with prefix value in above config set to `eu` will result in a cluster being created with name `eu17`. This is generated by terraform scripts in the [ops repository](https://github.com/gitpod-io/ops)
1. We follow a set of steps as mentioned below. Each step may or may not have a pre run check. For example creating a workspace cluster will likely have a check to see if a cluster with the generated name already exists
    1. **CreateClusterStep** - Use [build-cluster.sh](https://github.com/gitpod-io/ops/blob/main/dev/build-ws-cluster/build-ws-cluster.sh) script to generate terraform modules.
    1. **InstallGitpodStep** - Use `helm install` to install gitpod
    1. **InstallJaegerStep** - TODO
    1. **InstallMonitoringStep** - TODO
    1. **SmokeTestStep** - TODO
    1. **RegisterClusterStep** - TODO
    1. **TrafficShiftStep** - TODO


# Where does this Run
I propose we use a werft job (e.g. [branch](https://github.com/gitpod-io/ops/tree/prs/wspace-cluster-auto) where I am trying to do this. This is outdated though) inside the [ops repository](https://github.com/gitpod-io/ops) and then build this cli in the submodule `gitpod-core`.

I propose we give the ops repository's commit as an input to this werft job (just like how we do it now). The version of gitpod in the values version yaml file will be used to deploy gitpod.

Alternatively, once we have installer production ready, we can use gitpod commit ids to deploy a specific version of gitpod.

# Current Status
We are far away from having anything executable. I have been only able to create the framework for writing prerun checks and steps. We need to do these (in parallel):

* We have support to create a workspace cluster

# Next Phase
In the next phase we would want to achive the following:
1. Metrics based traffic shift
1. Rollback on failure metrics
1. Cluster destruction post complete traffic migration
