on:
  workflow_call:
    # inputs:
    #   productName:
    #     type: string
    #     required: true
    #   productId:
    #     type: string
    #     required: true
    #   productCode:
    #     type: string
    #     required: true
    #   productType:
    #     type: string
    #     required: true
    #   exampleRepo:
    #     type: string
    #     required: true
    secrets:
      slackWebhook:
        required: true

jobs:
  update-jetbrains:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Update
        run: |
          cd ./components/ide/jetbrains/image/gha-update-image
          yarn install
          node index.js
      - uses: technote-space/get-diff-action@v6
        with:
          FILES: WORKSPACE.yaml
      - name: Create Pull Request
        if: env.GIT_DIFF
        uses: peter-evans/create-pull-request@v4
        with:
          title: "[JetBrains] Update IDE images to new build version"
          body: |
            ## Description
            This PR updates the JetBrains IDE images to the latest release version.

            ## How to test
            1. For each IDE changed on this PR, follow these steps:
            1. Open the preview environment generated for this branch
            1. Choose the stable version of the IDE that you're testing as your default editor
            1. Start a workspace using any repository (e.g: `https://github.com/gitpod-io/empty`)
            1. Verify that the workspace starts successfully
            1. Verify that the IDE opens successfully
            1. Verify that the version of the IDE corresponds to the one being updated in this PR

            The following resources should help, in case something goes wrong (e.g. workspaces don't start):

            - https://www.gitpod.io/docs/troubleshooting#gitpod-logs-in-jetbrains-gateway
            - https://docs.google.com/document/d/1K9PSB0G6NwX2Ns_SX_HEgMYTKYsgMJMY2wbh0p6t3lQ

            ## Release Notes
            ```release-note
            Update JetBrains IDE images to latest version.
            ```

            ## Werft options:
            <!--
            Optional annotations to add to the werft job.
            * with-preview - whether to create a preview environment for this PR
            -->
            - [x] /werft with-preview

            _This PR was created automatically with GitHub Actions using [this](https://github.com/gitpod-io/gitpod/blob/main/.github/workflows/jetbrains-updates-template.yml) template_
          commit-message: "[JetBrains] Update IDE images to new build version"
          branch: "jetbrains/${{ inputs.productId }}-${{ steps.latest-release.outputs.version2 }}"
          labels: "team: IDE,editor: jetbrains"
          team-reviewers: "engineering-ide"
      - name: Get previous job's status
        id: lastrun
        uses: filiptronicek/get-last-job-status@main
      - name: Slack Notification
        if: ${{ (success() && steps.lastrun.outputs.status == 'failed') || failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.slackWebhook }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: ${{ inputs.productName }}
